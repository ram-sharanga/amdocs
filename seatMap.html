<!DOCTYPE html>
<html>
<head>
  <title>Seat Booking</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    .seat {
      display: inline-block;
      width: 50px;
      height: 50px;
      margin: 5px;
      line-height: 50px;
      text-align: center;
      border: 2px solid #444;
      border-radius: 8px;
      user-select: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
    .seat.selected {
      background-color: #4caf50;
      color: white;
    }
    .seat.blocked {
      background-color: #ccc;
      cursor: not-allowed;
      color: #888;
    }
    #book-btn {
      display: none;      /* hidden, we use Telegram.MainButton instead */
    }
  </style>
</head>
<body>
  <h2>Select Your Seats</h2>
  <div id="seat-map"></div>
  <!-- fallback button if Telegram isn't available -->
  <button id="book-btn">Book Selected Seats</button>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // --- Configuration ---
    const BACKEND_URL = "https://yourbackend.com/registerBooking"; 
    const rows = ["A", "B", "C"];
    const cols = ["1", "2", "3"];
    const blockedSeats = new Set(["A2", "B3"]);
    const selected = new Set();

    // --- DOM references ---
    const seatMapDiv = document.getElementById("seat-map");
    const fallbackBtn = document.getElementById("book-btn");
    const tg = window.Telegram.WebApp;

    // --- Render seats ---
    function renderSeats() {
      seatMapDiv.innerHTML = "";
      rows.forEach(row => {
        cols.forEach(col => {
          const id = row + col;
          const div = document.createElement("div");
          div.textContent = id;
          div.className = "seat";
          if (blockedSeats.has(id)) {
            div.classList.add("blocked");
          } else {
            div.addEventListener("click", () => {
              if (selected.has(id)) selected.delete(id);
              else selected.add(id);
              updateUI();
            });
          }
          seatMapDiv.appendChild(div);
        });
        seatMapDiv.appendChild(document.createElement("br"));
      });
    }

    // --- Update UI and Telegram MainButton ---
    function updateUI() {
      document.querySelectorAll(".seat").forEach(el => {
        el.classList.toggle("selected", selected.has(el.textContent));
      });
      const hasSelection = selected.size > 0;
      // configure the built‑in MainButton:
      tg.MainButton.setText(
        hasSelection
          ? `Book: ${[...selected].join(", ")}`
          : "Select seats first"
      );
      if (hasSelection) tg.MainButton.show();
      else tg.MainButton.hide();
      // fallback button:
      fallbackBtn.disabled = !hasSelection;
    }

    // --- Booking handler ---
    function bookSeats() {
      const seats = [...selected];
      const payload = { user: tg.initDataUnsafe.user, bookedSeats: seats };

      // send to your backend
      fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => {
          if (!res.ok) throw new Error("Network response was not OK");
          return res.json();
        })
        .then(data => {
          // backend should call Bot API to send confirmation
          tg.close();
        })
        .catch(err => {
          console.error("Booking error:", err);
          alert("❌ Booking failed. Try again.");
        });
    }

    // --- Initialization ---
    tg.ready();
    renderSeats();
    updateUI();

    // when MainButton is clicked:
    tg.MainButton.onClick(bookSeats);

    // fallback for non‑Telegram environments:
    fallbackBtn.addEventListener("click", bookSeats);
  </script>
</body>
</html>
